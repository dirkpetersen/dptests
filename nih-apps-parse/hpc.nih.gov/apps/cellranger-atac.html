<script type="text/javascript" language="JavaScript" src='/js/header.js'></script>
<!-- Start content - do not edit above this line  -->
<script type='text/javascript' language='JavaScript'>document.querySelector('title').textContent = 'cellranger-atac on Biowulf';</script>
<div class="title">cellranger-atac on Biowulf</div>

<table width=25% align=right>
  <tr>
    <td>
      <div class="toc">
        <div class="tocHeading">Quick Links</div>
        <div class="tocItem"><A href="#doc">Documentation</a></div>
        <div class="tocItem"><a href="#notes">Notes</a></div>
        <div class="tocItem"><a href="#int">Interactive job </a></div>
        <div class="tocItem"><a href="#sbatch">Batch job </a></div>
        <div class="tocItem"><a href="#swarm">Swarm of jobs </a></div>
      </div>
</table>

<p>From the Cell Ranger manual:</p>

<blockquote>
Cell Ranger ATAC is a set of analysis pipelines that process Chromium Single Cell ATAC data. Cell Ranger ATAC includes two pipelines relevant to single cell chromatin accessibility experiments:

<ul>
    <li><em>cellranger-atac mkfastq</em> demultiplexes raw base call (BCL) files generated by Illumina® sequencers into FASTQ files. It is a wrapper around bcl2fastq from Illumina®, with additional useful features that are specific to 10x Genomics libraries and a simplified sample sheet format.</li>

    <li><em>cellranger-atac count</em> takes FASTQ files from cellranger-atac mkfastq and performs ATAC analysis, including:
<ul>
<li>Read filtering and alignment</li>
<li>Barcode counting</li>
<li>Identification of transposase cut sites</li>
<li>Detection of accessible chromatin peaks</li>
<li>Cell calling</li>
<li>Count matrix generation for peaks and transcription factors</li>
<li>Dimensionality reduction</li>
<li>Cell clustering</li>
<li>Cluster differential accessibility</li>
</ul>

    </li>
</ul>
</blockquote>

<a Name="doc"></a><div class="heading">Documentation</div>
<ul>
    <li><a href="https://support.10xgenomics.com/single-cell-atac/software/pipelines/latest/what-is-cell-ranger-atac">Home page + Manual</a>
    </li>
</ul>

<div class="heading">Important Notes</div>
<ul>
    <li>Module Name: cellranger-atac (see <a href="/apps/modules.html">the modules page</a> for more information)</li>
    <li>cellranger-atac can operate in <span style="background-color: #ffff99">local mode</span> or 
    <span style="background-color: #ffff99">cluster mode</span>. In both cases, the local part of the job will use
    multiple CPUs. Users have to specify the number of allocated CPUs and amount of memory
    with <code style="background-color: #ffff99">--localcores=# --localmem=#</code> to cellranger-atac.</li>
    <li style="background-color: #ffff99">cellranger-atac may attempt to start more processes or open more files than the default limits
    on our compute nodes allow. If you encounter errors or strange results, you may have to raise these limits.
    See below for more deails.</li>
    <li>Reference data can be found in /fdb/cellranger-atac</li>
    <li>Test data can be found in  <code>$CELLRANGER_ATAC_TEST_DATA</code></li>
</ul>
<P>

<a Name="int"></a><div class="heading">Interactive job</div>
<div class="nudgeblock"><a href="/docs/userguide.html#int">Interactive jobs</a> should be used for debugging, graphics, or applications that cannot be run as batch jobs.</div>

<p>Allocate an <a href="/docs/userguide.html#int">interactive session</a> and run the program. Sample session:</p>

<p>Copy the bcl format test data and run the demux pipeline</p>
<pre class="term">
[user@biowulf]$ <b>sinteractive --cpus-per-task=6 --mem=35g</b>
salloc.exe: Pending job allocation 46116226
salloc.exe: job 46116226 queued and waiting for resources
salloc.exe: job 46116226 has been allocated resources
salloc.exe: Granted job allocation 46116226
salloc.exe: Waiting for resource configuration
salloc.exe: Nodes cn3144 are ready for job

[user@cn3144 ~]$ <b>module load cellranger-atac</b>
[user@cn3144 ~]$ <b>cp $CELLRANGER_ATAC_TEST_DATA/* .</b>
[user@cn3144 ~]$ <b>tar -xzf cellranger-atac-tiny-bcl-1.0.0.tar.gz</b>
[user@cn3144 ~]$ <b>cellranger-atac mkfastq --run=cellranger-atac-tiny-bcl-1.0.0 \
                     --samplesheet=cellranger-atac-tiny-bcl-samplesheet-1.0.0.csv \
                     --localcores=$SLURM_CPUS_PER_TASK \
                     --localmem=34</b>
cellranger-atac mkfastq (2.1.0)
Copyright (c) 2018 10x Genomics, Inc.  All rights reserved.
-------------------------------------------------------------------------------

Martian Runtime - '1.0.0-v3.1.0'
2018-11-09 14:28:35 [runtime] Reattaching in local mode.
Serving UI at http://cn3338:34493?auth=6-NvgOIWcH55W8qw0EKM9b_AZbhmwjCbD1CBbXgO_9M

2018-11-09 14:28:35 [runtime] (reset-partial)   ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MAKE_FASTQS_PREFLIGHT.fork0.chnk0
2018-11-09 14:28:35 [runtime] Found orphaned local stage: ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MAKE_FASTQS_PREFLIGHT
2018-11-09 14:28:38 [runtime] (ready)           ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.PREPARE_SAMPLESHEET
2018-11-09 14:28:38 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.PREPARE_SAMPLESHEET.fork0.chnk0.main
2018-11-09 14:28:41 [runtime] (chunks_complete) ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.PREPARE_SAMPLESHEET
2018-11-09 14:28:41 [runtime] (ready)           ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.BCL2FASTQ_WITH_SAMPLESHEET
2018-11-09 14:28:41 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.BCL2FASTQ_WITH_SAMPLESHEET.fork0.split
2018-11-09 14:28:44 [runtime] (split_complete)  ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.BCL2FASTQ_WITH_SAMPLESHEET
2018-11-09 14:28:44 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.BCL2FASTQ_WITH_SAMPLESHEET.fork0.chnk0.main
2018-11-09 14:29:03 [runtime] (chunks_complete) ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.BCL2FASTQ_WITH_SAMPLESHEET
2018-11-09 14:29:03 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.BCL2FASTQ_WITH_SAMPLESHEET.fork0.join
2018-11-09 14:29:06 [runtime] (join_complete)   ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.BCL2FASTQ_WITH_SAMPLESHEET
2018-11-09 14:29:07 [runtime] (ready)           ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MAKE_QC_SUMMARY
2018-11-09 14:29:07 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MAKE_QC_SUMMARY.fork0.split
2018-11-09 14:29:10 [runtime] (split_complete)  ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MAKE_QC_SUMMARY
2018-11-09 14:29:10 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MAKE_QC_SUMMARY.fork0.join
2018-11-09 14:29:16 [runtime] (join_complete)   ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MAKE_QC_SUMMARY
2018-11-09 14:29:16 [runtime] (ready)           ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MERGE_FASTQS_BY_LANE_SAMPLE
2018-11-09 14:29:16 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MERGE_FASTQS_BY_LANE_SAMPLE.fork0.split
2018-11-09 14:29:20 [runtime] (split_complete)  ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MERGE_FASTQS_BY_LANE_SAMPLE
2018-11-09 14:29:21 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MERGE_FASTQS_BY_LANE_SAMPLE.fork0.chnk0.main
2018-11-09 14:29:24 [runtime] (chunks_complete) ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MERGE_FASTQS_BY_LANE_SAMPLE
2018-11-09 14:29:24 [runtime] (run:local)       ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MERGE_FASTQS_BY_LANE_SAMPLE.fork0.join
2018-11-09 14:29:27 [runtime] (join_complete)   ID.HJN3KBCX2.MAKE_FASTQS_CS.MAKE_FASTQS.MERGE_FASTQS_BY_LANE_SAMPLE

Outputs:
- Run QC metrics:        null
- FASTQ output folder:   /data/teacher/test/HJN3KBCX2/outs/fastq_path
- Interop output folder: /data/teacher/test/HJN3KBCX2/outs/interop_path
- Input samplesheet:     /data/teacher/test/HJN3KBCX2/outs/input_samplesheet.csv

Waiting 6 seconds for UI to do final refresh.
Pipestance completed successfully!

2018-11-09 14:29:33 Shutting down.
Saving pipestance info to HJN3KBCX2/HJN3KBCX2.mri.tgz
</pre>

<p style="background-color: #ffff99">Note that it is necessary to specify
<code>--localcores</code> and <code>--localmem</code>.</p>

<p>cellranger-atac may start an unreasonable number of processes or open too many
files. If you encounter errors that include</p>

<pre class="term">
...
 self.pid = os.fork()
OSError: [Errno 11] Resource temporarily unavailable 
</pre>

<p>or see unexpected results despite specifying <code>--localcores</code> and
<code>--localmem</code>, you may have to raise the limit on the number of
processes and/or open files allowed in your batch script:</p>

<pre class="term">
[user@cn3144 ~]$ <b>ulimit -u 10240 -n 16384</b>
[user@cn3144 ~]$ <b>cellranger-atac mkfastq --run=cellranger-atac-tiny-bcl-1.0.0 \
                     --samplesheet=cellranger-atac-tiny-bcl-samplesheet-1.0.0.csv \
                     --localcores=$SLURM_CPUS_PER_TASK \
                     --localmem=34</b>
</pre>

<p>Generate counts per gene per cell</p>
<pre class="term">
[user@cn3144 ~]$ <b>cellranger-atac count --id p1 \
  --fastqs HJN3KBCX2/outs/fastq_path \
  --reference=/fdb/cellranger-atac/refdata-cellranger-arc-GRCh38-2020-A-2.0.0 \
  --localcores=$SLURM_CPUS_PER_TASK --localmem=34</b>
  cellranger-atac count (2.1.0)
Copyright (c) 2018 10x Genomics, Inc.  All rights reserved.
-------------------------------------------------------------------------------

Martian Runtime - '1.0.0-v3.1.0'
Serving UI at http://cn3338:35263?auth=koRZfC445oeJTiOKaz9N6qBn_tZFsmYLIaiWrqbbZNA

Running preflight checks (please wait)...
2018-11-09 14:54:16 [runtime] (ready)           ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.SETUP_CHUNKS
2018-11-09 14:54:16 [runtime] (run:local)       ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.SETUP_CHUNKS.fork0.chnk0.main
2018-11-09 14:54:25 [runtime] (chunks_complete) ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.SETUP_CHUNKS
2018-11-09 14:54:25 [runtime] (ready)           ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.TRIM_READS
2018-11-09 14:54:25 [runtime] (run:local)       ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.TRIM_READS.fork0.split
2018-11-09 14:54:28 [runtime] (split_complete)  ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.TRIM_READS
2018-11-09 14:54:28 [runtime] (run:local)       ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.TRIM_READS.fork0.chnk0.main
2018-11-09 14:55:01 [runtime] (chunks_complete) ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.TRIM_READS
2018-11-09 14:55:01 [runtime] (run:local)       ID.p1.SC_ATAC_COUNTER_CS.SC_ATAC_COUNTER._BASIC_SC_ATAC_COUNTER._ALIGNER.TRIM_READS.fork0.join
[...]

node$ <b>exit</b>
biowulf$
</pre>

<p>The same job could also be run in cluster mode where pipeline tasks
are submitted as batch jobs. This can be done by setting jobmode to slurm
and limiting the max. number of concurrent jobs:</p>

<pre class="term">
[user@cn3144 ~]$ <b>cellranger-atac count --id s1 \
                --fastqs HJN3KBCX2/outs/fastq_path \
                --reference=/fdb/cellranger-atac/refdata-cellranger-arc-GRCh38-2020-A-2.0.0 \
                --localcores=$SLURM_CPUS_PER_TASK \
                --localmem=34 \
                --jobmode=slurm --maxjobs=10</b>
</pre>

<p>Don't forget to close the interactive session when done</p>
<pre class="term">
[user@cn3144 ~]$ <b>exit</b>
salloc.exe: Relinquishing job allocation 46116226
[user@biowulf ~]$
</pre>

<p>Though in the case of this small example this actually results in
a longer overall runtime. Even when running in cluster mode, please run
the main pipeline in an sinteractive session or as a batch job itself.</p>

<P>
<a Name="sbatch"></a><div class="heading">Batch job</div>
<div class="nudgeblock">Most jobs should be run as <A href="/docs/userguide.html#submit">batch jobs</a>.</div>
<p>Create a batch input file (e.g. cellranger-atac.sh), which uses the input file 'cellranger-atac.in'. For example:</p>

<pre class="term">
#! /bin/bash
module load cellranger-atac || exit 1
## uncomment the following line if encountering 'resource unavailable' errors
## despite using --localcores and --localmem
# ulimit -u 4096
cellranger-atac mkfastq --run=cellranger-atac-tiny-bcl-1.2.0 \
                     --samplesheet=cellranger-atac-tiny-bcl-samplesheet-1.0.0.csv \
                     --localcores=$SLURM_CPUS_PER_TASK \
                     --localmem=34
cellranger-atac count --id p1 \
  --fastqs HJN3KBCX2/outs/fastq_path \
  --reference=/fdb/cellranger-atac/refdata-cellranger-arc-GRCh38-2020-A-2.0.0 \
  --localcores=$SLURM_CPUS_PER_TASK --localmem=34
</pre>
<p>Again, please remember to include <code>--localcoes</code> and <code>--localmem</code>.</p>
<p>Submit this job using the Slurm <a href="/docs/userguide.html">sbatch</a> command.</p>

<pre class="term">sbatch --cpus-per-task=12 --mem=35g cellranger-atac.sh</pre>

<a Name="swarm"></a><div class="heading">Swarm of Jobs </div>
<div class="nudgeblock">A <a href="/apps/swarm.html">swarm of jobs</a> is an easy way to submit a set of independent commands requiring identical resources.</div>

<p>Create a swarmfile (e.g. cellranger-atac.swarm). For example:</p>

<pre class="term">
cellranger-atac mkfastq --run=./run1 --localcores=$SLURM_CPUS_PER_TASK --localmem=34
cellranger-atac mkfastq --run=./run2 --localcores=$SLURM_CPUS_PER_TASK --localmem=34
cellranger-atac mkfastq --run=./run3 --localcores=$SLURM_CPUS_PER_TASK --localmem=34
</pre>

<p>Submit this job using the <a href='/apps/swarm.html'>swarm</a> command.</p>

<pre class="term">swarm -f cellranger-atac.swarm -g 35 -t 12 --module cellranger-atac</pre>
where
<table border=0>
  <tr><td width=20%>-g # <td>Number of Gigabytes of memory required for each process (1 line in the swarm command file)
  <tr><td>-t # <td>Number of threads/CPUs required for each process (1 line in the swarm command file).
  <tr><td>--module cellranger-atac <td>Loads the cellranger-atac module for each subjob in the swarm 
</table>




<!-- End content area - do not edit below this line -->
<script type="text/javascript" language="JavaScript" src='/js/footer.js'></script>
